<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת התראות - בזמן אמת</title>
    
    <style>
        /* משתני מערכת שה-JS קורא ומשנה */
        :root {
            --background-color: #121212;
            --alert-color: #5a0000; /* צבע אדום כהה למצב אזעקה */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: #ffffff;
            margin: 0;
            padding: 20px;
            transition: background-color 0.4s ease-in-out; /* מעבר צבע חלק */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: 0.2s;
        }

        button:hover { background: #3a3a3a; }
        #test { background: #005500; border-color: #007700; }
        #test:hover { background: #007700; }

        .layout {
            display: flex;
            width: 100%;
            max-width: 1000px;
            gap: 20px;
        }

        /* רשימת ההתראות */
        #alerts-container {
            width: 320px;
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .alerts-header {
            background: #252525;
            padding: 15px;
            margin: 0;
            border-bottom: 1px solid #333;
            font-size: 1.1em;
            text-align: center;
        }

        #alerts {
            padding: 15px;
            height: 500px;
            overflow-y: auto;
        }

        /* אזור הדמיית מפה */
        #map-area {
            flex-grow: 1;
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.2em;
        }

        /* עיצוב פס גלילה */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <div class="header-controls">
        <button id="alertButton">שנה רקע למצב התראה</button>
        <button id="test">בדיקת התראה (שדרות)</button>
    </div>

    <div class="layout">
        <div id="alerts-container">
            <h3 class="alerts-header">התראות אחרונות</h3>
            <div id="alerts">
                </div>
        </div>

        <div id="map-area">
            <div>
                מפה תוצג כאן בפרויקט המלא
                <div style="font-size: 0.6em; margin-top: 10px; color: #555;">(ה-JS תומך בסנכרון עם app.js המקורי שלך)</div>
            </div>
        </div>
    </div>

    <script>
        const r = document.querySelector(':root');
        let backgroundColor;
        const alertButton = document.querySelector('#alertButton');
        const testButton = document.getElementById("test");
        const alertsDiv = document.getElementById("alerts");

        let detectedRedAlert = false;
        let count = 0;
        let Alerts = JSON.parse(localStorage.getItem('storedAlerts')) || [];

        function getBackground() {
            const rs = getComputedStyle(r);
            backgroundColor = rs.getPropertyValue('--background-color').trim() || "#121212";
        }
        getBackground();

        function alertBackground() {
            r.style.setProperty('--background-color', 'var(--alert-color)');
        }

        function deAlertBackground() {
            r.style.setProperty('--background-color', backgroundColor);
        }

        if (alertButton) {
            alertButton.addEventListener('click', () => {
                detectedRedAlert ? deAlertBackground() : alertBackground();
                detectedRedAlert = !detectedRedAlert;
            });
        }

        function addAlertEntry(title, id) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString('he-IL');
            
            if (Alerts.find(a => a.id === id && a.title === title)) return;

            const alertData = { title, time: timestamp, id: id };
            Alerts.unshift(alertData);
            Alerts = Alerts.slice(0, 50);
            localStorage.setItem('storedAlerts', JSON.stringify(Alerts));

            const alertHTML = `
              <div class="alt" style="animation: fadeIn 0.4s ease-out; margin-bottom: 8px; padding: 12px; background: rgba(255,255,255,0.05); border-right: 4px solid #f44336; border-radius: 4px;">
                <div style="font-weight: 600; font-size: 1.1em; color: white; margin-bottom: 4px;">${title}</div>
                <div style="font-size: 0.8em; color: #aaa;">${timestamp}</div>
              </div>
            `;
            if (alertsDiv) alertsDiv.insertAdjacentHTML("afterbegin", alertHTML);
        }

        function updateMapLocation(cityName) {
            // קריאה לפונקציות המפה של app.js אם קיימות (לא יקרוס אם חסר)
            if (typeof City !== 'undefined' && typeof currentCities !== 'undefined') {
                const city = new City(cityName, 0, false, Math.floor(Date.now() / 1000));
                if (!currentCities.some(c => c.name === cityName)) {
                    currentCities.push(city);
                    if (typeof updateAlertsUI === 'function') updateAlertsUI();
                }
            }
        }

        function handleRedAlert(area, id) {
            if (!detectedRedAlert) {
                alertBackground();
                detectedRedAlert = true;
                count = 0;
            }
            addAlertEntry(area, id);
            updateMapLocation(area);
        }

        async function getAlerts() {
            try {
                const targetUrl = "https://api.tzevaadom.co.il/notifications";
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&cache=${Date.now()}`;
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                const content = data.contents;

                // הבדיקה הקריטית - האם קיבלנו דף חסימה HTML?
                if (!content || content.trim().startsWith("<!DOCTYPE") || content.trim().startsWith("<html")) {
                    console.log("ה-Proxy חסום זמנית. מנסה שוב בעוד 3 שניות...");
                    setTimeout(getAlerts, 3000);
                    return;
                }

                let parsedAlerts = [];
                try {
                    parsedAlerts = JSON.parse(content);
                } catch (parseError) {
                    setTimeout(getAlerts, 3000);
                    return;
                }

                if (Array.isArray(parsedAlerts) && parsedAlerts.length > 0) {
                    parsedAlerts.forEach(notification => {
                        const id = notification.notificationId;
                        if (notification.cities) {
                            notification.cities.forEach(city => {
                                handleRedAlert(city, id);
                            });
                        }
                    });
                }

                if (detectedRedAlert) {
                    count++;
                    if (count > 60) {
                        deAlertBackground();
                        detectedRedAlert = false;
                        count = 0;
                        if (typeof restartData === 'function') restartData();
                    }
                }

                setTimeout(getAlerts, 1000);

            } catch (err) {
                setTimeout(getAlerts, 5000);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            Alerts.forEach(({ title, time }) => {
                const alertHTML = `
                  <div class="alt" style="margin-bottom: 8px; padding: 12px; background: rgba(255,255,255,0.05); border-right: 4px solid #555; border-radius: 4px;">
                    <div style="font-weight: 600; font-size: 1.1em; color: #ddd; margin-bottom: 4px;">${title}</div>
                    <div style="font-size: 0.8em; color: #888;">${time}</div>
                  </div>
                `;
                if (alertsDiv) alertsDiv.insertAdjacentHTML("beforeend", alertHTML);
            });
            
            getAlerts();
        });

        if (testButton) {
            testButton.addEventListener("click", () => {
                handleRedAlert("שדרות (בדיקה)", "test-" + Date.now());
            });
        }
        
        // הוספת סגנון האנימציה דינמית
        const animStyle = document.createElement('style');
        animStyle.innerHTML = `@keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }`;
        document.head.appendChild(animStyle);
    </script>
</body>
</html>
